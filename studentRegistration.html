<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="author" content="Sunil, Priya, Thina, saiy2k">
        <title>Student Registration | Vegam 2k15</title>
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
        <link type="text/css" rel="stylesheet" href="vegam.css"/>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.3.2.min.js"></script>
        <script type="text/javascript" src="./angular.min.js"></script>
        <script>

            var myApp = angular.module('rowRepeaterApp', []);
            myApp.controller('repeaterController', ['$scope', function ($scope) {
            }]);

            //Parse.initialize("avx8N1dxzO7BU1QTkrSGC0ibcowObI9Q4kvikfn2", "ndSz3O9ZMkpjQtaRUrNcLOsVHfbWT9hwxaxSSgO5");
            Parse.initialize("BlYcmQmAAvCsDdanA7TJh14KiHrCCqb3z5vPz1Ay", "ovGdJ7e9MJ0wqqcsadYauC9t5aiXvluiuqBrvf3x");

            studentList             =   null;
            schoolObject            =   null;
            isPopulating            =   true;
            function loadSchool() {
                var schoolClass     =   Parse.Object.extend("User");
                var squery          =   new Parse.Query(schoolClass);
                squery.get(sessionStorage.school, {
                    success:function(sobj) {
                        var stuClass=   Parse.Object.extend("Student");
                        var stQuery =   new Parse.Query(stuClass);
                        schoolObject=   sobj;
                        stQuery.equalTo("school", sobj);
                        stQuery.ascending("no");
                        stQuery.find({
                            success:function(students) {
                                studentList =   students;
                                lindex = 1;
                                if (students.length)
                                    populateFields();
                            }, error:function(stobj, sterr) {
                                console.log('Error fetching student' + sterr.message);
                            }
                        });
                    }, error:function(sobj, serr) {
                        console.log('Error fetching school' + serr.message);
                    }
                });
            }

            var lindex = 1;
            function populateFields() {
                var students = studentList;
                var i = lindex-1;
                var index       =   i+1;
                var categ       =   students[i].get('CATEGORY');
                $('#userNameField' + index).val(students[i].get('USERNAME'));
                $('#rollNumberField' + index).val(students[i].get('ROLLNUMBER'));
                $('#ageField' + index).val(students[i].get('AGE'));
                $('#sexCombo' + index).val(students[i].get('GENDER'));
                $('#categoryCombo' + index).val(categ);
                $('#MRLevel' + index).hide();
                if (categ == 'MR') {
                    $('#MRLevel' + index).val(students[i].get('LEVEL'));
                    $('#MRLevel' + index).show();
                } else if (categ == 'VI') {
                    $('#VILevel' + index).val(students[i].get('LEVEL'));
                    $('#VILevel' + index).show();
                }
                isPopulating    =   true;
                getEvents(index);
                lindex++;

                if (lindex <= students.length ) {
                    setTimeout(populateFields(), 1000);
                }
            }

            $( document ).ready(function() {
                var edge = ($(window).width() - ($('#studTable').offset().left + $('#studTabe').outerWidth()));
                $('#saveButton').css({left: edge});
                $('#logoutButton').css({left: edge});
                loadSchool();

            });

        </script>
    </head>

    <body>

        <!-- Top section contains the Vegam Title and Page Title -->
        <div class="header"> 
            <h1> <a href="index.html"> Vegam 2k15 </a> </h1>
            <h3> Student Registration </h3>
        </div>

        <!-- Main cotent section that contains all the page controls -->
        <div class="content" style="text-align: center">
			<p><b> MR:</b> Mentally Retarded <b> | VI:</b> Visually Impaired<b> | HI:</b> Hearing Impaired<b> | MD:</b> Multi Disordered </p>
            <table id="studTable" width="900px" align="center" border="1" ng-app="rowRepeaterApp" ng-controller="repeaterController">
                <tr>
                    <th width="4%"> No </th>
                    <th width="10%"> Name </th>
                    <th width="6%"> Roll Number </th>
                    <th width="4%"> Age </th>
                    <th width="4%"> Sex </th>
                    <th width="5%"> Disability </th>
                    <th width="5%"> D.Level</th>
                    <th width="30%"> Events </th>
                </tr>

                <tr ng-repeat="n in [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30]" id="{{'stuRow' + n}}" >
                    <td> {{ n }} </td>
                    <td> <input type="text" id="{{'userNameField' + n}}" size="18"/> </td>
                    <td> <input type="text" id="{{'rollNumberField' + n}}" size="10"/> </td>
                    <td> <input type="text" id="{{'ageField' + n}}" size="1" value="12" onChange="ageChange(this)"> </td>
                    <td>
                        <select id="{{'sexCombo' + n}}" onChange="sexSelect(this)">
                            <option value="M"> M</option>
                            <option value="F"> F</option>
                        </select>
                    </td>

                    <td>
                        <select id="{{'categoryCombo' + n}}" onChange="categorySelect(this)">
                            <option value="MR"> MR </option>
                            <option value="MD"> MD </option>
                            <option value="HI"> HI </option>
                            <option value="VI"> VI </option>
                        </select>
                    </td>

                    <td>
                        <select id="{{'MRLevel' + n}}" onChange="subCategorySelect(this)">
                            <option value="1"> MILD </option>
                            <option value="2"> MODERATE </option>
                            <option value="3"> SEVERE </option>
                        </select>
                        <select id="{{'VILevel' + n}}" style="display:none" onChange="subCategorySelect(this)">
                            <option value="1"> Partially Blind </option>
                            <option value="2"> Totally Blind </option>
                        </select>
                    </td>

                    <td id="{{'eventRow' + n}}" style="padding:2px;text-align:left">

                    </td>
                </tr>

            </table>
            <br/>
            <br/>
            <div id="rowOverlay" style="display:none; background-color:rgba(200, 100, 100, 0.5); position:absolute; text-align:center; vertical-align:middle; font-size: 24px;"> ...processing... </div>
        </div>

        <!-- Floating logo stick to the bottom right of the screen -->
        <img class="logo" src="k.png"/>

        <div class="button" style="position:fixed; bottom:70px; " id='logoutButton' onclick="logout()"> Logout </div>
        <div class="button" style="position:fixed; bottom:30px; " id='saveButton' onclick="index=1; updateTable()"> Save </div>

        <!-- Footer that sticks to the bottom of the screen (not document) -->
        <p class="footer"> <a href="http://chennaisocialservice.org/"> Chennai Social Service </a> - Powered by <a href="https://plus.google.com/u/0/communities/104455776462402572964">Indian National Developers</a> </p>

    </body>
    </html>

    <script>

        function logout() {
            Parse.User.logOut();
            window.location         =   "index.html";
        }

        var index                   =   1;
        function updateTable() {
            var studName            =   $("#userNameField" + index).val();
            var rollNo              =   $("#rollNumberField" + index).val();
            var studAge             =   $("#ageField" + index).val();
            if(studName.length == 0 && rollNo.length == 0) {
                setTimeout(function() {
                    $("#rowOverlay").fadeOut();
                }, 6000);
            } else {

                var studClass       =   Parse.Object.extend("Student");
                var query           =   new Parse.Query(studClass);
                var rowIndex        =   index;

                if (studName == "") {
                    alert('Student name should not be empty for the row ' + index);
                    index++;
                    setTimeout(updateTable(), 1000);
                    return;
                }   

                if (studAge.length == 0) {
                    alert('Student age should not be empty for the student' + $('#userNameField' + index).val());
                    index++;
                    setTimeout(updateTable(), 1000);
                    return;
                }   

                if (rollNo.length == 0) {
                    alert('Student Roll Number should not be empty for the student' + $('#userNameField' + index).val());
                    index++;
                    setTimeout(updateTable(), 1000);
                    return;
                }   

                query.equalTo("school", schoolObject);
                query.equalTo("ROLLNUMBER", rollNo);
                query.first({
                    success:function(studObj) {
                        if (studObj) {
                            saveButtonClick(studObj, rowIndex);
                        } else {
                            var StudentReg  =   Parse.Object.extend("Student");
                            var studentReg  =   new StudentReg();
                            saveButtonClick(studentReg, rowIndex);
                        }
                    },
                    error: function(studerror) {
                    }
                });
                index++;
                setTimeout(updateTable(), 1000);
            }

        }

        function ageChange(domObj) {
            var idStr               =   domObj.getAttribute('id');
            var index               =   idStr.slice(8);
		    getEvents(index);
        }

        function sexSelect(domObj) {
            var idStr               =   domObj.getAttribute('id');
            var index               =   idStr.slice(8);
			getEvents(index);
        }

        function categorySelect(domObj) {
            var idStr               =   domObj.getAttribute('id');
            var index               =   idStr.slice(13);
            if(document.getElementById('categoryCombo' + index ).value == "MR") {
                document.getElementById("MRLevel" + index).style.display = 'block';
                document.getElementById("VILevel" + index).style.display = 'none';
            }else if(document.getElementById('categoryCombo' + index).value == "VI") {
                document.getElementById("VILevel" + index).style.display = 'block';
                document.getElementById("MRLevel" + index).style.display = 'none';
            }else{
                document.getElementById("VILevel" + index).style.display = 'none';
                document.getElementById("MRLevel" + index).style.display = 'none';
            }

            getEvents(index);
        };

        function subCategorySelect(domObj) {
            var idStr               =   domObj.getAttribute('id');
            var index               =   idStr.slice(7);
            getEvents(index);
        }

        function getEvents(rowIndex) {
            var container           =   document.getElementById('eventRow'+rowIndex);

            $divOverlay             =   $("#rowOverlay");
            $rowOverlay             =   $("#stuRow" + rowIndex);
            var rowTop              =   $rowOverlay.position().top;
            var rowLeft             =   $rowOverlay.position().left;
            var rowWidth            =   $rowOverlay.css('width');
            var rowHeight           =   $rowOverlay.css('height');
            $divOverlay.css({
                position            :   'absolute',
                top                 :   rowTop,
                left                :   rowLeft,
                width               :   rowWidth,
                height              :   rowHeight
            });
            $divOverlay.show();

            var eventsClass         =   Parse.Object.extend("EVENTS");
            var query               =   new Parse.Query(eventsClass);

            var sexValue            =   $('#sexCombo' + rowIndex).val();
            var ageValue            =   parseInt($('#ageField' + rowIndex).val());
            var categoryValue       =   $('#categoryCombo' + rowIndex).val();

            query.equalTo("GENDER", sexValue);
            query.lessThanOrEqualTo("AGE_MIN", ageValue);
            query.greaterThanOrEqualTo("AGE_MAX", ageValue);;
            query.equalTo("D_Category", categoryValue); 

            if(categoryValue == "MR") {
                var levelValue      =   parseInt($('#MRLevel' + rowIndex).val());
                query.equalTo("D_Level_1_2_3", levelValue);
            } else if (categoryValue == "VI") {
                var levelValue      =   parseInt($('#VILevel' + rowIndex).val());
                query.equalTo("D_Level_1_2_3", levelValue);
            }

            query.find({
                success:function(results) {
                    //empty the event cell for the given row
                    while (container.hasChildNodes()) {
                        container.removeChild(container.lastChild);
                    }

                    populateEventCellWithEvents(results, rowIndex);
                    $divOverlay.fadeOut();
                }, 
                error: function(error) {
                    console.log('Failure retrieveing events' + error.message );
                }
            });

        }

        function populateEventCellWithEvents(events, rowIndex) {
            var container           =   document.getElementById('eventRow'+rowIndex);
            events.forEach(function(event) {
                //console.log(event.id);
                var checkbox        =   document.createElement('input');
                checkbox.type       =   "checkbox";
                checkbox.id         =   event.id;

                var label           =   document.createElement('label')
                label.htmlFor       =   event.id;
                label.appendChild(document.createTextNode(event.get('EVENT_NAME')));

                container.appendChild(checkbox);
                container.appendChild(label);
                container.appendChild(document.createElement('br'));

                if(isPopulating && studentList[rowIndex-1]) {
                    var event1Obj = studentList[rowIndex-1].get('event1');
                    if (event1Obj && event1Obj.id == event.id) {
                        checkbox.checked = true;
                    }
                    var event2Obj = studentList[rowIndex-1].get('event2');
                    if (event2Obj && event2Obj.id == event.id) {
                        checkbox.checked = true;
                    }
                }
            });

        };

        function saveButtonClick(studentReg, index){	
            var categoryValue       =   $('#categoryCombo' + index).val();
            var eventCell           =   $("#eventRow" + index );
            var checkedBoxes        =   eventCell.find(":checked")

            var studName            =   $('#userNameField' + index).val();
            var studRoll            =   $('#rollNumberField' + index).val();

            if (checkedBoxes.length > 2 || checkedBoxes.length == 0) {
                alert('Select a minimum of 2 events for the student ' + studName);
                return;
            }

            if (studName.length == 0) {
                alert('Student name should not be empty for the row number' + index);
                return;
            }   

            $divOverlay             =   $("#rowOverlay");
            $rowOverlay             =   $("#stuRow" + index);
            var rowTop              =   $rowOverlay.position().top;
            var rowLeft             =   $rowOverlay.position().left;
            var rowWidth            =   $rowOverlay.css('width');
            var rowHeight           =   $rowOverlay.css('height');
            $divOverlay.css({
                position            :   'absolute',
                top                 :   rowTop,
                left                :   rowLeft,
                width               :   rowWidth,
                height              :   rowHeight
            });
            $divOverlay.show();

            studentReg.set("no", index);;
            studentReg.set("USERNAME", studName);
            studentReg.set("ROLLNUMBER",studRoll);
            studentReg.set("GENDER",document.getElementById("sexCombo" + index).value);
            studentReg.set("AGE",document.getElementById("ageField" + index).value);
            studentReg.set("CATEGORY", categoryValue);
            studentReg.set("event1", null);
            studentReg.set("event2", null);
            studentReg.set('school', schoolObject);
            if(categoryValue == "MR") {
                studentReg.set("LEVEL",document.getElementById("MRLevel" + index).value);
            } else if (categoryValue == "VI") {
                studentReg.set("LEVEL",document.getElementById("VILevel" + index).value);
            }

            var checkLength         =   checkedBoxes.length;
            checkedBoxes.each(function(i) {
                var eventsClass     =   Parse.Object.extend("EVENTS");
                var query           =   new Parse.Query(eventsClass);
                query.get(this.getAttribute('id'), {
                    success:function(obj) {
                        if (i == 0) {
                            studentReg.set('event1', obj);
                        } else if (i == 1) {
                            studentReg.set('event2', obj);
                        }
                        if (i == checkLength - 1) {
                            studentReg.save(null, {
                                success: function(studentObj) {
                                },
                                error: function(studentObj, error) {
                                    alert('Failed to create new object, with error code: ' + error.message);
                                }
                            });
                        }
                    }, error: function (obj) {
                    }
                });
            });
       };
		
		function name(){
			var a = document.getElementById('userNameField').value;
			if(a=="")
			{
				alert("Please Enter Your Name");
				document.getElementById('userNameField').focus();
				return false;
			}
			if(!isNaN(a))
			{
				alert("Please Enter Only Characters");
				return false;
			}
			if ((a.length < 5) || (a.length > 15))
			{
				alert("Your Character must be 5 to 15 Character");
				return false;
			}
	};
    </script>
